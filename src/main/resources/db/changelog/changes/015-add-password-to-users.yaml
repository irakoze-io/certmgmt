databaseChangeLog:
  - changeSet:
      id: 015-add-password-to-users
      author: ivanirakoze
      changes:
        - sql:
            sql: |
              -- Add password column to users table in tenant schemas
              -- This migration adds the password column to all existing tenant schemas
              -- Note: For new tenant schemas, the create_tenant_schema function will include this column
              
              DO $$
              DECLARE
                  schema_record RECORD;
              BEGIN
                  -- Loop through all schemas that match tenant naming pattern
                  FOR schema_record IN 
                      SELECT schema_name 
                      FROM information_schema.schemata 
                      WHERE schema_name NOT IN ('information_schema', 'pg_catalog', 'pg_toast', 'public')
                      AND schema_name ~ '^[a-z][a-z0-9_]*$'
                  LOOP
                      -- Check if users table exists in this schema
                      IF EXISTS (
                          SELECT 1 
                          FROM information_schema.tables 
                          WHERE table_schema = schema_record.schema_name 
                          AND table_name = 'users'
                      ) THEN
                          -- Check if password column already exists
                          IF NOT EXISTS (
                              SELECT 1 
                              FROM information_schema.columns 
                              WHERE table_schema = schema_record.schema_name 
                              AND table_name = 'users' 
                              AND column_name = 'password'
                          ) THEN
                              -- Add password column
                              EXECUTE format('ALTER TABLE %I.users ADD COLUMN password VARCHAR(255) NOT NULL DEFAULT ''{noop}changeme''', schema_record.schema_name);
                              RAISE NOTICE 'Added password column to %.users', schema_record.schema_name;
                          END IF;
                      END IF;
                  END LOOP;
              END $$;
            splitStatements: false
            stripComments: false
      rollback:
        sql: |
          -- Rollback: Remove password column from all tenant schemas
          DO $$
          DECLARE
              schema_record RECORD;
          BEGIN
              FOR schema_record IN 
                  SELECT schema_name 
                  FROM information_schema.schemata 
                  WHERE schema_name NOT IN ('information_schema', 'pg_catalog', 'pg_toast', 'public')
                  AND schema_name ~ '^[a-z][a-z0-9_]*$'
              LOOP
                  IF EXISTS (
                      SELECT 1 
                      FROM information_schema.columns 
                      WHERE table_schema = schema_record.schema_name 
                      AND table_name = 'users' 
                      AND column_name = 'password'
                  ) THEN
                      EXECUTE format('ALTER TABLE %I.users DROP COLUMN password', schema_record.schema_name);
                  END IF;
              END LOOP;
          END $$;
